<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Church Check-In - Register</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #3498db;
            --danger: #e74c3c;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f7ff 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            min-height: 100vh;
        }

        .container {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        label {
            font-weight: 500;
            margin-top: 15px;
            display: block;
            color: #333;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .note {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        #children_field, #parent_field, #minor_field, #address_field {
            margin-top: 15px;
        }

        button {
            margin-top: 25px;
            width: 100%;
            padding: 14px;
            font-size: 17px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        a {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: var(--secondary);
            text-decoration: none;
            font-weight: 500;
        }

        a:hover {
            text-decoration: underline;
        }

        .gender-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .gender-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gender-option input {
            margin: 0;
        }
        
        .error-messages {
            background-color: #ffebee;
            border-left: 4px solid var(--danger);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .error-message {
            color: var(--danger);
            margin: 5px 0;
            font-size: 0.95rem;
        }

        .error-input {
            border: 1px solid var(--danger) !important;
        }

        .error-label {
            color: var(--danger);
        }

        .minor-option {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .minor-note {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .session-timeout {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            display: none;
            z-index: 1000;
        }

        @media screen and (max-width: 600px) {
            body {
                padding: 20px;
            }

            .container {
                padding: 25px;
            }
            
            .gender-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .error-messages {
                padding: 10px;
                font-size: 0.9rem;
            }
            
            button {
                padding: 16px;
            }
        }
 </style>
</head>
<body>
    <div class="session-timeout" id="sessionTimeout">
        Session expiring in <span id="timeoutCounter">2:00</span> minutes
    </div>
    
    <div class="container">
        <h2>
            <i class="bi bi-person-plus"></i> Register
        </h2>
        
        {% if errors %}
        <div class="error-messages">
            {% for error in errors %}
            <div class="error-message">‚ùå {{ error }}</div>
            {% endfor %}
        </div>
        {% endif %}
        
        <form method="POST" action="/register" id="registerForm" novalidate>
            <label for="first_name">First Name:
                <input type="text" name="first_name" id="first_name" required oninput="validateName(this)">
            </label>
            <div id="first_name_error" class="error-message" style="display:none;"></div>

            <label for="last_name">Last Name:
                <input type="text" name="last_name" id="last_name" required oninput="validateName(this)">
            </label>
            <div id="last_name_error" class="error-message" style="display:none;"></div>

            <label for="email">Email:
                <input type="email" name="email" id="email" required oninput="validateEmail(this)">
                <div class="note">Must be unique - QR code will be sent to this email</div>
            </label>
            <div id="email_error" class="error-message" style="display:none;"></div>

            <label for="phone">Phone Number:
                <input type="tel" name="phone" id="phone" required oninput="validatePhone(this)">
                <div class="note">Must be unique</div>
            </label>
            <div id="phone_error" class="error-message" style="display:none;"></div>

            <label>Gender:</label>
            <div class="gender-group">
                <label class="gender-option"><input type="radio" name="gender" value="Male" required> Male</label>
                <label class="gender-option"><input type="radio" name="gender" value="Female"> Female</label>
                <label class="gender-option"><input type="radio" name="gender" value="Other"> Other</label>
            </div>

            <label for="role">Role:
                <select name="role" id="role" required onchange="updateFields()">
                    <option value="Adult">Adult (without children OR adults with children over 18)</option>
                    <option value="Parent">Parent/Guardian (with children)</option>
                    <option value="Child">Child (Under 18)</option>
                </select>
            </label>
            <label for="date_of_birth">Date of Birth:
  <input type="date" name="date_of_birth" id="date_of_birth" required>
</label>
<div id="dob_error" class="error-message" style="display:none;"></div>

<script>
// prevent future dates
document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('date_of_birth');
  const today = new Date().toISOString().split('T')[0];
  inp.max = today;
});
</script>

            <!-- üîπ Address Field -->
            <div id="address_field" style="display:none;">
               <label for="address">Address (optional):
               <input type="text" name="address" id="address">
               <div class="note">Only for Adults</div>
              </label>
            </div>
            <div id="children_field" style="display:none;">
                <label for="children">Children's First Names (comma separated):
                    <input type="text" name="children" id="children" oninput="validateChildren(this)">
                    <div class="note">* Last name will be added automatically</div>
                </label>
                <div id="children_error" class="error-message" style="display:none;"></div>
            </div>

            <!-- ‚úÖ Parent Selection with Search -->
<div id="parent_field" style="display:none;">
  <label for="parent">Parent(s)/Guardian(s):</label>
  <div class="note">Search and select up to 2 parents</div>

  <!-- Search box (kept) -->
  <input type="text" id="parent_search" placeholder="Search parents..." oninput="filterParents()" style="width:100%; padding: 8px; margin-bottom: 10px;">

  <div id="parent_checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
    {% for parent in registered_parents %}
      {% set parts = parent.split() %}
      {% set last = parts[-1] if parts|length > 0 else '' %}
      <label class="checkbox-option" 
             data-lastname="{{ last|lower }}" 
             style="display:none; margin:5px 0;">
        <input type="checkbox" name="parent" value="{{ parent }}" onchange="limitParentCheckboxes(this)">
        {{ parent }}
      </label>
    {% endfor %}
  </div>

  <div id="parent_error" class="error-message" style="display:none;"></div>
</div>

            <button type="submit" id="registerButton">
                <i class="bi bi-person-check"></i> 
                <span id="registerText">Register</span>
                <span class="spinner" id="spinner" style="display:none;"></span>
            </button>
        </form>

        <a href="/"><i class="bi bi-arrow-left"></i> Back to Home</a>
    </div>

    <!-- Scripts -->
   <script>
    const SESSION_TIMEOUT_MINUTES = 30;
    let sessionTimeout = SESSION_TIMEOUT_MINUTES * 60;
    let sessionTimer;
    const sessionTimeoutElement = document.getElementById('sessionTimeout');

    function startSessionTimer() {
        clearInterval(sessionTimer);
        sessionTimeout = SESSION_TIMEOUT_MINUTES * 60;
        updateSessionTimerDisplay();

        sessionTimer = setInterval(() => {
            sessionTimeout--;
            updateSessionTimerDisplay();
            if (sessionTimeout <= 0) {
                clearInterval(sessionTimer);
                alert('Your session has expired. Please log in again.');
                window.location.href = '/admin-login?expired=1';
            } else if (sessionTimeout <= 120) {
                sessionTimeoutElement.style.display = 'block';
            }
        }, 1000);
    }

    function updateSessionTimerDisplay() {
        const minutes = Math.floor(sessionTimeout / 60);
        const seconds = sessionTimeout % 60;
        document.getElementById('timeoutCounter').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    document.addEventListener('click', startSessionTimer);
    document.addEventListener('keypress', startSessionTimer);

    // ---------- UI field visibility ----------
    function updateFields() {
        const role = document.getElementById('role').value;

        document.getElementById('children_field').style.display = role === 'Parent' ? 'block' : 'none';
        document.getElementById('parent_field').style.display   = role === 'Child'  ? 'block' : 'none';

        // Address: show only for Adults; clear when hidden
        const addrWrap  = document.getElementById('address_field');
        const addrInput = document.getElementById('address');
        if (addrWrap) {
            if (role === 'Adult') {
                addrWrap.style.display = 'block';
            } else {
                addrWrap.style.display = 'none';
                if (addrInput) addrInput.value = '';
            }
        }

        // When switching to Child, refresh suggested parents by surname
        if (role === 'Child') {
            updateParentSuggestions();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        startSessionTimer();
        updateFields();

        // Hook surname updates and search
        const lastNameInput   = document.getElementById('last_name');
        const parentSearchInp = document.getElementById('parent_search');
        if (lastNameInput)   lastNameInput.addEventListener('input', updateParentSuggestions);
        if (parentSearchInp) parentSearchInp.addEventListener('input', updateParentSuggestions);

        // Initial suggestions (in case role is already Child)
        updateParentSuggestions();
    });

    // ---------- Validation ----------
    function validateName(input) {
        const errorElement = document.getElementById(`${input.id}_error`);
        if (/[0-9]/.test(input.value)) {
            errorElement.textContent = "‚ùå Names cannot contain numbers";
            errorElement.style.display = "block";
            input.classList.add("error-input");
            return false;
        }
        if (input.value.trim().length < 2) {
            errorElement.textContent = "‚ùå Name must be at least 2 characters";
            errorElement.style.display = "block";
            input.classList.add("error-input");
            return false;
        }
        errorElement.style.display = "none";
        input.classList.remove("error-input");
        return true;
    }

    function validateEmail(input) {
        const errorElement = document.getElementById("email_error");
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(input.value)) {
            errorElement.textContent = "‚ùå Please enter a valid email";
            errorElement.style.display = "block";
            input.classList.add("error-input");
            return false;
        }
        errorElement.style.display = "none";
        input.classList.remove("error-input");
        return true;
    }

    function validatePhone(input) {
        const errorElement = document.getElementById("phone_error");
        const phoneDigits = input.value.replace(/\D/g, '');
        if (phoneDigits.length < 7) {
            errorElement.textContent = "‚ùå Please enter a valid phone number";
            errorElement.style.display = "block";
            input.classList.add("error-input");
            return false;
        }
        errorElement.style.display = "none";
        input.classList.remove("error-input");
        return true;
    }

    function validateChildren(input) {
        const errorElement = document.getElementById("children_error");
        const names = input.value.split(',').map(n => n.trim());
        for (const name of names) {
            if (!name) continue;
            if (/[0-9]/.test(name)) {
                errorElement.textContent = `‚ùå Child name "${name}" contains numbers`;
                errorElement.style.display = "block";
                input.classList.add("error-input");
                return false;
            }
            if (name.length < 2) {
                errorElement.textContent = `‚ùå Child name "${name}" is too short`;
                errorElement.style.display = "block";
                input.classList.add("error-input");
                return false;
            }
        }
        errorElement.style.display = "none";
        input.classList.remove("error-input");
        return true;
    }

    function limitParentCheckboxes(checkbox) {
        const checked = document.querySelectorAll('#parent_checkboxes input[type="checkbox"]:checked');
        if (checked.length > 2) {
            checkbox.checked = false;
            alert("‚ùó You can only select up to 2 parents.");
        }
    }

    // ---------- Parent suggestions (surname + search) ----------
    function lastWord(str) {
        const parts = (str || '').trim().split(/\s+/);
        return parts.length ? parts[parts.length - 1].toLowerCase() : '';
    }

    function updateParentSuggestions() {
        const role = document.getElementById('role')?.value;
        if (role !== 'Child') return; // only relevant in Child mode

        const childLast = lastWord(document.getElementById('last_name')?.value || '');
        const searchVal = (document.getElementById('parent_search')?.value || '').trim().toLowerCase();
        const labels = document.querySelectorAll('#parent_checkboxes label');

        // If user is typing in search, use search filter
        if (searchVal) {
            labels.forEach(label => {
                const text = label.textContent.toLowerCase();
                label.style.display = text.includes(searchVal) ? 'block' : 'none';
            });
            return;
        }

        // Otherwise, suggest by surname: show only matching last names
        labels.forEach(label => {
            const parentText = label.textContent || '';
            const parentLast = lastWord(parentText);
            if (childLast && parentLast === childLast) {
                label.style.display = 'block';
            } else {
                label.style.display = 'none';
            }
        });
    }

    // filterParents now delegates to surname+search logic
    function filterParents() {
        updateParentSuggestions();
    }

    function validateForm() {
        let isValid = true;
        if (!validateName(document.getElementById("first_name"))) isValid = false;
        if (!validateName(document.getElementById("last_name")))  isValid = false;
        if (!validateEmail(document.getElementById("email")))     isValid = false;
        if (!validatePhone(document.getElementById("phone")))     isValid = false;

        const role = document.getElementById("role").value;
        if (role === "Parent" && !validateChildren(document.getElementById("children"))) {
            isValid = false;
        }
        if (role === "Child") {
            const checkedParents = document.querySelectorAll('#parent_checkboxes input[type="checkbox"]:checked');
            if (checkedParents.length === 0) {
                const err = document.getElementById("parent_error");
                err.textContent = "‚ùå Parent/Guardian is required";
                err.style.display = "block";
                isValid = false;
            } else {
                document.getElementById("parent_error").style.display = "none";
            }
        }
        return isValid;
    }

    document.getElementById("registerForm").addEventListener("submit", function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return;
        }
        const registerButton = document.getElementById("registerButton");
        registerButton.disabled = true;
        document.getElementById("spinner").style.display = "inline-block";
        document.getElementById("registerText").textContent = "Processing...";
    });
</script>
</body>
</html>
